# SPDX-FileCopyrightText: no
# SPDX-License-Identifier: CC0-1.0
#
# Contextualprocess module to mount btrfs subvolumes
# This runs after subvolumes are created and replaces the standard mount for btrfs

---

dontChroot: true
timeout: 120

# Mount btrfs subvolumes in the correct order
firmwareType:
    "*":
        - command: "/bin/bash"
          args:
            - "-c"
            - |
              # This script mounts btrfs subvolumes to the target directory
              # Get target directory from Calamares (usually /tmp/calamares-root)
              TARGET="@@ROOT@@"
              ROOT_PART="@@ROOT@@"

              if [ -z "$ROOT_PART" ]; then
                  echo "ERROR: No root partition specified"
                  exit 1
              fi

              # Check if btrfs
              FS_TYPE=$(lsblk -no FSTYPE "$ROOT_PART" 2>/dev/null || echo "")
              if [ "$FS_TYPE" != "btrfs" ]; then
                  echo "Not btrfs filesystem, using standard mount"
                  exit 0
              fi

              echo "Mounting btrfs subvolumes..."

              # Base mount options
              OPTS="defaults,noatime,compress=zstd,space_cache=v2"

              # Check for SSD
              DEV_NAME=$(basename "$ROOT_PART" | sed 's/[0-9]*$//')
              if [ -f "/sys/block/$DEV_NAME/queue/rotational" ]; then
                  ROTATIONAL=$(cat "/sys/block/$DEV_NAME/queue/rotational")
                  if [ "$ROTATIONAL" = "0" ]; then
                      OPTS="$OPTS,ssd,discard=async"
                      echo "SSD detected, adding optimizations"
                  fi
              fi

              # Mount root subvolume first
              echo "Mounting @ to $TARGET"
              mkdir -p "$TARGET"
              mount -t btrfs -o "subvol=@,$OPTS" "$ROOT_PART" "$TARGET"

              # Mount other subvolumes
              declare -A SUBVOLS=(
                  ["@home"]="/home"
                  ["@log"]="/var/log"
                  ["@cache"]="/var/cache"
                  ["@libvirt"]="/var/lib/libvirt"
                  ["@flatpak"]="/var/lib/flatpak"
                  ["@docker"]="/var/lib/docker"
                  ["@containers"]="/var/lib/containers"
                  ["@machines"]="/var/lib/machines"
                  ["@var_tmp"]="/var/tmp"
                  ["@tmp"]="/tmp"
                  ["@opt"]="/opt"
                  ["@swap"]="/swap"
              )

              for subvol_name in "@home" "@log" "@cache" "@libvirt" "@flatpak" "@docker" "@containers" "@machines" "@var_tmp" "@tmp" "@opt" "@swap"; do
                  case "$subvol_name" in
                      "@home") mount_point="/home" ;;
                      "@log") mount_point="/var/log" ;;
                      "@cache") mount_point="/var/cache" ;;
                      "@libvirt") mount_point="/var/lib/libvirt" ;;
                      "@flatpak") mount_point="/var/lib/flatpak" ;;
                      "@docker") mount_point="/var/lib/docker" ;;
                      "@containers") mount_point="/var/lib/containers" ;;
                      "@machines") mount_point="/var/lib/machines" ;;
                      "@var_tmp") mount_point="/var/tmp" ;;
                      "@tmp") mount_point="/tmp" ;;
                      "@opt") mount_point="/opt" ;;
                      "@swap") mount_point="/swap" ;;
                  esac

                  full_path="$TARGET$mount_point"
                  mkdir -p "$full_path"

                  # Use nodatacow for certain subvolumes
                  case "$subvol_name" in
                      "@log"|"@cache"|"@libvirt"|"@docker"|"@containers"|"@machines"|"@var_tmp"|"@tmp"|"@swap")
                          echo "Mounting $subvol_name to $mount_point (nodatacow)"
                          mount -t btrfs -o "subvol=$subvol_name,$OPTS,nodatacow" "$ROOT_PART" "$full_path"
                          ;;
                      *)
                          echo "Mounting $subvol_name to $mount_point"
                          mount -t btrfs -o "subvol=$subvol_name,$OPTS" "$ROOT_PART" "$full_path"
                          ;;
                  esac
              done

              echo "All btrfs subvolumes mounted"
          timeout: 120

i18n:
    name: "Mounting Btrfs subvolumes..."
