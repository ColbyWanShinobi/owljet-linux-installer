# SPDX-FileCopyrightText: no
# SPDX-License-Identifier: CC0-1.0
#
# Contextualprocess module to create btrfs subvolumes
# This runs after partitioning but before mounting

---

dontChroot: true
timeout: 60

# This process creates btrfs subvolumes based on filesystem type
firmwareType:
    "*":
        - command: "/bin/bash"
          args:
            - "-c"
            - |
              # Check if root partition is btrfs
              ROOT_PART="@@ROOT@@"
              if [ -z "$ROOT_PART" ]; then
                  echo "No root partition found, skipping btrfs subvolume creation"
                  exit 0
              fi

              FS_TYPE=$(lsblk -no FSTYPE "$ROOT_PART" 2>/dev/null || echo "")
              if [ "$FS_TYPE" = "btrfs" ]; then
                  echo "Root filesystem is btrfs, creating subvolumes..."
                  /etc/calamares/scripts/create-btrfs-subvolumes.sh "$ROOT_PART"
              else
                  echo "Root filesystem is not btrfs ($FS_TYPE), skipping subvolume creation"
              fi
          timeout: 60

i18n:
    name: "Creating Btrfs subvolumes..."
